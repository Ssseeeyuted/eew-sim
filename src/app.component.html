<div class="flex flex-col h-screen w-full bg-slate-950 text-slate-100 overflow-hidden font-sans relative">
  
  <!-- Header -->
  <header class="h-14 flex items-center justify-between px-4 bg-slate-900 border-b border-slate-800 z-30 shrink-0">
    <div class="flex items-center gap-3">
      <div class="bg-gradient-to-br from-red-600 to-purple-800 p-1.5 rounded text-white shadow-lg animate-pulse">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      </div>
      <div>
        <h1 class="text-sm md:text-lg font-bold tracking-wider text-slate-100 leading-tight">Âú∞ÈúáÈÄüÂ†±<span class="text-red-500">PRO</span> <span class="text-xs text-slate-500">TAIWAN-JAPAN</span></h1>
        <p class="text-[9px] text-slate-500 font-mono tracking-widest uppercase hidden md:block">
            Á≥ªÁµ±ÁãÄÊÖã: {{systemStatus()}} | ÈÄ£Á∑öÊ∏¨Á´ô: {{stations().length}} 
        </p>
      </div>
    </div>
    
    <div class="flex items-center gap-2 md:gap-4">
      <!-- Mute Button -->
      <button (click)="toggleMute()" class="p-2 rounded hover:bg-slate-800 transition-colors" title="ÈùúÈü≥ÈñãÈóú">
        @if (isMuted()) {
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v6a3 3 A0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        }
      </button>

      <!-- Dashboard Toggle (Desktop) -->
      <button 
        (click)="toggleTools()"
        class="hidden md:flex px-3 py-1.5 rounded text-xs font-bold items-center gap-2 transition-colors border"
        [class]="showTools() ? 'bg-blue-600 border-blue-500 text-white shadow-[0_0_10px_#2563eb]' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        Áõ£ÊéßÂÑÄË°®Êùø
      </button>

      @if (isSimulating()) {
        <div class="font-mono text-xl text-yellow-400 font-bold bg-black/40 px-3 py-1 rounded border border-yellow-500/30 whitespace-nowrap">
            T+{{elapsedTime().toFixed(1)}}s
        </div>
      }
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden relative">
    
    <!-- Sidebar / Bottom Sheet for Controls -->
    <div class="
        fixed inset-x-0 bottom-0 md:static md:w-80 md:inset-auto z-40
        bg-slate-900 border-t md:border-t-0 md:border-r border-slate-800 
        flex flex-col shadow-2xl transition-transform duration-300
        max-h-[60vh] md:max-h-full overflow-hidden
      "
      [class.translate-y-full]="!showMobileControls() && isMobile()"
      [class.translate-y-0]="showMobileControls() || !isMobile()"
    >
        <!-- Mobile Handle -->
        <div class="md:hidden w-full flex justify-center py-3 bg-slate-800/80 cursor-pointer active:bg-slate-700" (click)="toggleMobileControls()">
             <div class="w-12 h-1.5 bg-slate-600 rounded-full"></div>
        </div>

        <div class="p-4 space-y-4 md:space-y-6 overflow-y-auto flex-1 pb-10 md:pb-4">
            
            <!-- CITY COUNTDOWN PANELS (Separated by Strategy) -->
            @if (mainCountdowns().length > 0) {
                 <div class="bg-slate-950 border border-slate-700 rounded p-3 space-y-2 animate-in slide-in-from-left duration-300">
                    <div class="text-[10px] text-red-500 font-bold uppercase flex justify-between border-b border-red-900/50 pb-1">
                         <span>‰∏ªÈúá/ÁÅ´Â±± ÊäµÈÅîÂÄíÊï∏ (MAIN/VOLCANO)</span>
                         <span class="animate-pulse">‚ö† CRITICAL</span>
                    </div>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        @for (city of mainCountdowns(); track city.name) {
                            <div class="flex items-center justify-between p-2 rounded bg-red-950/30 border-l-4" [style.border-color]="city.color">
                                <div class="flex flex-col">
                                    <span class="text-sm font-bold text-white">{{city.name}}</span>
                                    <span class="text-[9px] text-slate-400">È†ê‰º∞ÈúáÂ∫¶: {{city.intensity}}</span>
                                </div>
                                <span class="text-2xl font-black font-mono leading-none" [class.text-red-500]="city.seconds <= 10">
                                    {{city.seconds.toFixed(0)}}<span class="text-[10px] text-slate-500">s</span>
                                </span>
                            </div>
                        }
                    </div>
                 </div>
            }

            @if (secondaryCountdowns().length > 0) {
                 <div class="bg-slate-950 border border-slate-700 rounded p-3 space-y-2 animate-in slide-in-from-left duration-300 delay-100">
                    <div class="text-[10px] text-yellow-500 font-bold uppercase flex justify-between border-b border-yellow-900/50 pb-1">
                         <span>È§òÈúáÊäµÈÅîÂÄíÊï∏ (AFTERSHOCKS)</span>
                         <span>‚ö† WARNING</span>
                    </div>
                    <div class="space-y-2 max-h-32 overflow-y-auto">
                        @for (city of secondaryCountdowns(); track city.name) {
                            <div class="flex items-center justify-between p-2 rounded bg-slate-900/80 border-l-4 border-slate-600">
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-slate-300">{{city.name}}</span>
                                    <span class="text-[9px] text-slate-500">È†ê‰º∞ÈúáÂ∫¶: {{city.intensity}}</span>
                                </div>
                                <span class="text-lg font-bold font-mono leading-none text-slate-300">
                                    {{city.seconds.toFixed(0)}}<span class="text-[9px] text-slate-500">s</span>
                                </span>
                            </div>
                        }
                    </div>
                 </div>
            }

            <!-- EEW Report Section (Accumulating) -->
            @if (eewReports().length > 0) {
                 <div class="bg-slate-950 border border-slate-700 rounded p-3 space-y-2">
                    <div class="text-[10px] text-green-500 font-bold uppercase flex justify-between">
                         <span>Âº∑ÈúáÂç≥ÊôÇË≠¶Â†±ÂàóË°® (Strategy/Live)</span>
                         <span class="animate-pulse">LIVE</span>
                    </div>
                    <!-- Accumulating List -->
                    <div class="h-48 overflow-y-auto space-y-1 font-mono text-[10px] bg-black/50 p-2 rounded flex flex-col-reverse">
                        @for (report of eewReports(); track report.id) {
                            <div class="grid grid-cols-[auto_1fr] gap-2 border-b border-slate-800/50 pb-1 mb-1 last:border-0 shrink-0">
                                <span class="text-slate-500">#{{report.reportNum}}</span>
                                <div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-300 font-bold">È†ê‰º∞Ë¶èÊ®° M{{report.mag.toFixed(1)}}</span>
                                        <span class="text-slate-400">T+{{report.time.toFixed(1)}}s</span>
                                    </div>
                                    <div class="text-slate-500">
                                        Ê∑±Â∫¶: {{report.depth}}km | Ëß∏ÁôºÊ∏¨Á´ô: {{report.stations}}
                                        <div class="text-yellow-600/80 text-[9px] mt-0.5" *ngIf="report.isOffshore">‚ö† Â§ñÊµ∑ÂÅµÊ∏¨ (Offshore)</div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                 </div>
            }

            <!-- Presets -->
            <div class="space-y-2">
                <div class="text-[10px] text-slate-500 font-bold uppercase flex items-center justify-between">
                   <span class="flex items-center gap-2">Ê≠∑Âè≤ÊÉÖÂ¢É (Policy/History)</span>
                   <button (click)="loadRecentQuakes()" class="text-blue-400 hover:text-blue-300 text-[10px] flex items-center gap-1">
                      {{ isLoadingRecents() ? 'ÂêåÊ≠•‰∏≠...' : 'Áç≤ÂèñÂàóË°®' }}
                   </button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button (click)="applyPreset('921')" class="bg-slate-800 hover:bg-slate-700 p-2 rounded text-xs text-slate-300 border border-slate-700 transition-all hover:border-red-500">921 ÈõÜÈõÜÂú∞Èúá</button>
                    <button (click)="applyPreset('0403')" class="bg-slate-800 hover:bg-slate-700 p-2 rounded text-xs text-slate-300 border border-slate-700 transition-all hover:border-red-500">0403 Ëä±ËìÆÂú∞Èúá</button>
                    @for (quake of recentQuakes(); track $index) {
                      <button (click)="applyPreset(quake)" class="bg-slate-800/50 hover:bg-slate-700 p-2 rounded text-xs text-blue-300 border border-blue-900/30 transition-all hover:border-blue-500 text-left truncate">
                        {{quake.name.slice(0,6)}} (M{{quake.magnitude}})
                      </button>
                    }
                </div>
            </div>

            <!-- Image Analysis -->
            <div class="space-y-2 pt-2 border-t border-slate-800">
                <div class="text-[10px] text-slate-500 font-bold uppercase">ÁÅΩÊÉÖÁÖßÁâáÂàÜÊûê (Gemini Vision)</div>
                <div class="flex gap-2">
                    <input type="file" #fileInput (change)="handleImageUpload($event)" class="hidden" accept="image/*">
                    <button (click)="fileInput.click()" class="flex-1 bg-slate-800 hover:bg-slate-700 p-2 rounded text-xs text-slate-300 border border-slate-700 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M20.4 14.5L16 10 4 20"/></svg>
                        ‰∏äÂÇ≥ÁÖßÁâá
                    </button>
                </div>
                @if (analyzingImage()) {
                    <div class="text-xs text-blue-400 animate-pulse">Ê≠£Âú®ÂàÜÊûêÂΩ±ÂÉè‰∏≠... (Thinking)</div>
                }
                @if (imageAnalysisResult()) {
                    <div class="bg-slate-800/50 p-2 rounded text-[10px] text-slate-300 max-h-32 overflow-y-auto whitespace-pre-wrap border border-slate-700">
                        {{imageAnalysisResult()}}
                    </div>
                }
            </div>

            <!-- Parameters -->
            <div class="space-y-3 pt-4 border-t border-slate-800">
                <div class="flex justify-between items-center">
                    <label class="text-xs text-slate-400 font-medium uppercase">Ë®≠ÂÆöË¶èÊ®° (Magnitude Mw)</label>
                    <span class="text-xl font-black font-mono px-2 rounded bg-slate-800 text-white">
                        {{magnitude().toFixed(1)}}
                    </span>
                </div>
                <input 
                    type="range" min="3.0" max="20.0" step="0.1" 
                    [value]="magnitude()" (input)="setMagnitude($event)"
                    class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-white"
                />
            </div>

            <div class="space-y-3">
                 <div class="flex justify-between items-center">
                    <label class="text-xs text-slate-400 font-medium uppercase">ÈúáÊ∫êÊ∑±Â∫¶ (Depth km)</label>
                    <span class="text-base font-bold font-mono text-slate-300">{{depth()}}</span>
                </div>
                <input 
                    type="range" min="0" max="150" step="1" 
                    [value]="depth()" (input)="setDepth($event)"
                    class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                />
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col gap-2 mt-4">
                <button 
                    (click)="spawnEarthquake()"
                    class="w-full py-4 rounded font-bold text-sm tracking-widest uppercase transition-all shadow-lg flex items-center justify-center gap-2 border border-transparent"
                    [class]="isSimulating() 
                        ? 'bg-purple-900/80 hover:bg-purple-800 text-white shadow-purple-900/30 border-purple-500' 
                        : 'bg-red-900/80 hover:bg-red-800 text-white shadow-red-900/30 border-red-500'"
                >
                    @if (isSimulating()) {
                    <span>‚ö† Ëß∏ÁôºÈÄ£ÈéñÈ§òÈúá (Trigger)</span>
                    } @else {
                    <span>ÂïüÂãïÊ®°Êì¨Â∫èÂàó (Start)</span>
                    }
                </button>
                
                <!-- NEW: Volcano Simulation Button -->
                <button 
                    (click)="spawnCompositeDisaster()"
                    class="w-full py-3 rounded font-bold text-sm tracking-widest uppercase transition-all shadow-lg flex items-center justify-center gap-2 border border-transparent bg-orange-900/80 hover:bg-orange-800 text-white shadow-orange-900/30 border-orange-500"
                >
                    <span>üåã Ë§áÂêàÂºèÁÅΩÂÆ≥ (Composite Disaster)</span>
                </button>
                
                @if (isSimulating()) {
                    <button 
                        (click)="emergencyStop()"
                        class="w-full py-3 rounded font-bold text-sm tracking-widest uppercase transition-all shadow-lg flex items-center justify-center gap-2 border border-red-500 bg-red-950 text-red-500 hover:bg-red-900"
                    >
                        <span>‚õî Á∑äÊÄ•ÂÅúÊ≠¢ (EMERGENCY STOP)</span>
                    </button>
                }
            </div>
        </div>
    </div>

    <!-- Right Dashboard (Desktop Only) -->
    @if (showTools() && !isMobile()) {
        <div class="w-[400px] bg-slate-950 border-l border-slate-800 flex flex-col z-30 shadow-2xl animate-in slide-in-from-right duration-200 absolute right-0 inset-y-0 md:static">
             <!-- Tabs -->
             <div class="flex border-b border-slate-800">
                @for (tab of ['Visual', 'Telemetry', 'Sys-200', 'Logs']; track tab) {
                  <button 
                    (click)="activeTab.set(tab)"
                    class="flex-1 py-2 text-[10px] font-bold transition-colors uppercase tracking-widest text-center"
                    [class]="activeTab() === tab ? 'bg-slate-900 text-blue-400 border-b-2 border-blue-500' : 'text-slate-600 hover:text-slate-300'"
                  >
                    @if(tab === 'Visual') { Ë¶ñË¶∫Âåñ }
                    @else if(tab === 'Telemetry') { ÈÅôÊ∏¨ }
                    @else if(tab === 'Sys-200') { Á≥ªÁµ±Áõ£Êéß }
                    @else { Êó•Ë™å }
                  </button>
                }
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-6 bg-[#050505]">
                
                @if (activeTab() === 'Visual') {
                    <div class="space-y-4">
                        <div class="text-[10px] font-bold text-blue-400 uppercase tracking-wider flex items-center gap-2 border-b border-slate-800 pb-1">
                             È°ØÁ§∫ÂúñÂ±§ (Layers)
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center justify-between text-xs text-slate-300 cursor-pointer hover:bg-slate-900 p-2 rounded border border-slate-800/50">
                                <span>Ê∏¨Á´ôÂàÜ‰Ωà ({{stations().length}} Nodes)</span>
                                <input type="checkbox" [checked]="showStations()" (change)="toggleShowStations()" class="accent-blue-500">
                            </label>
                            <label class="flex items-center justify-between text-xs text-slate-300 cursor-pointer hover:bg-slate-900 p-2 rounded border border-slate-800/50">
                                <span class="text-cyan-400">Êµ∑ÂòØÊµÆÊ®ô (Tsunami Buoys)</span>
                                <input type="checkbox" [checked]="showTsunamiStations()" (change)="toggleTsunamiStations()" class="accent-cyan-500">
                            </label>
                            <label class="flex items-center justify-between text-xs text-slate-300 cursor-pointer hover:bg-slate-900 p-2 rounded border border-slate-800/50">
                                <span class="text-orange-500">ÁÅ´Â±±Áõ£Ê∏¨ (Volcano Sensors)</span>
                                <input type="checkbox" [checked]="showVolcanoStations()" (change)="toggleVolcanoStations()" class="accent-orange-500">
                            </label>
                            <label class="flex items-center justify-between text-xs text-slate-300 cursor-pointer hover:bg-slate-900 p-2 rounded border border-slate-800/50">
                                <span>Âú∞ÈúáÊ≥¢Ââç (Wavefronts)</span>
                                <input type="checkbox" [checked]="showWaves()" (change)="toggleShowWaves()" class="accent-blue-500">
                            </label>
                        </div>

                         <!-- Selected Station Detail -->
                        @if (selectedStation()) {
                            <div class="mt-4 border border-slate-700 rounded bg-slate-900 p-3 animate-in fade-in slide-in-from-bottom-2">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-bold text-sm text-white">{{selectedStation().name}}</div>
                                    <button (click)="closeStationPopup()" class="text-slate-500 hover:text-white">‚úï</button>
                                </div>
                                <div class="grid grid-cols-2 gap-y-2 text-[10px] text-slate-400">
                                    <div>ID: {{selectedStation().id}}</div>
                                    <div>Âú∞Ë≥™: {{selectedStation().terrain}}</div>
                                    <div>ÂçÄÂüü: {{selectedStation().region}}</div>
                                    <div>È°ûÂûã: {{selectedStation().stationType}}</div>
                                    
                                    @if (selectedStation().intensity) {
                                        <div class="col-span-2 mt-2 pt-2 border-t border-slate-800 grid grid-cols-2 gap-2">
                                            <div class="bg-slate-800 p-1.5 rounded text-center">
                                                <div class="text-[9px] uppercase text-slate-500">ÈúáÂ∫¶ (Intensity)</div>
                                                <div class="text-xl font-black text-yellow-400">{{selectedStation().intensity}}</div>
                                            </div>
                                            <div class="bg-slate-800 p-1.5 rounded text-center">
                                                <div class="text-[9px] uppercase text-slate-500">PGA (gal)</div>
                                                <div class="text-xl font-mono text-purple-400">{{selectedStation().pga.toFixed(1)}}</div>
                                            </div>
                                            <div class="col-span-2 text-[9px] flex justify-between px-1 mt-1 border-t border-slate-800 pt-1">
                                                <span>P-Wave Arrive: {{selectedStation().pTime.toFixed(1)}}s</span>
                                                <span>S-Wave Arrive: {{selectedStation().sTime.toFixed(1)}}s</span>
                                            </div>
                                        </div>
                                    } @else {
                                         <div class="col-span-2 mt-2 pt-2 border-t border-slate-800 text-center italic text-slate-600">
                                            Á≠âÂæÖÊï∏Êìö... (Waiting for Event)
                                         </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (activeTab() === 'Telemetry') {
                    <div class="space-y-4">
                        <div class="text-[10px] font-bold text-purple-400 uppercase tracking-wider flex items-center gap-2 border-b border-slate-800 pb-1">
                            Âç≥ÊôÇÈÅôÊ∏¨Êï∏Êìö (Real-time)
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                             <div class="bg-slate-900 p-2 rounded border border-slate-800">
                                <div class="text-[9px] text-slate-500">ÂÖßÈô∏Ê∏¨Á´ôËß∏Áôº</div>
                                <div class="text-xl font-mono text-blue-400">{{ inlandTriggerCount() }}</div>
                            </div>
                            <div class="bg-slate-900 p-2 rounded border border-slate-800">
                                <div class="text-[9px] text-slate-500">Â§ñÊµ∑/Â≥∂Â∂ºÊ∏¨Á´ôËß∏Áôº</div>
                                <div class="text-xl font-mono text-yellow-400">{{ offshoreTriggerCount() }}</div>
                            </div>
                             <div class="bg-slate-900 p-2 rounded border border-slate-800">
                                <div class="text-[9px] text-slate-500">ÊúÄÂ§ßÂú∞ÂãïÂä†ÈÄüÂ∫¶ (PGA)</div>
                                <div class="text-xl font-mono text-purple-400">{{ currentPGA().toFixed(1) }} <span class="text-xs text-slate-600">gal</span></div>
                            </div>
                            <div class="bg-slate-900 p-2 rounded border border-slate-800">
                                <div class="text-[9px] text-slate-500">Á∏ΩËß∏ÁôºÊï∏ (Nodes)</div>
                                <div class="text-xl font-mono text-white">{{triggeredStations()}}</div>
                            </div>
                        </div>

                        <!-- 1000 Items Matrix - Professional Grid -->
                        <div class="space-y-1">
                            <div class="text-[9px] text-slate-500 uppercase flex justify-between">
                                <span>ÊÑüÊ∏¨Âô®Êï∏ÊìöÊµÅ (1000ch Data Stream)</span>
                                <span class="text-green-500 animate-pulse text-[9px] tracking-wider">SYNC {{ (1000/1000).toFixed(0) }}Hz</span>
                            </div>
                            <div class="h-[500px] overflow-y-auto font-mono text-[9px] leading-tight bg-black p-2 border border-slate-800 rounded scrollbar-hide">
                                <div class="grid grid-cols-5 gap-x-4 gap-y-0.5">
                                    @for (val of sensorMatrix(); track $index) {
                                        <div class="flex justify-between items-center text-slate-500">
                                            <span class="text-[8px] opacity-50">{{$index.toString().padStart(4, '0')}}</span>
                                            <span [class.text-red-500]="val > 50" [class.text-yellow-500]="val > 20 && val <= 50" [class.text-blue-400]="val <= 20">
                                                {{ val.toFixed(3) }}
                                            </span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (activeTab() === 'Sys-200') {
                    <div class="space-y-4 h-full">
                        <div class="text-[10px] font-bold text-cyan-400 uppercase tracking-wider flex items-center justify-between border-b border-slate-800 pb-1">
                             <span>Ê†∏ÂøÉÁ≥ªÁµ±Áõ£Êéß (System Grid)</span>
                             <span class="text-[9px] bg-cyan-900 text-cyan-200 px-1 rounded">200 Items</span>
                        </div>
                        <div class="grid grid-cols-4 gap-1 overflow-y-auto max-h-[700px] pr-1">
                            @for (item of systemGridItems(); track item.id) {
                                <div class="bg-slate-900 border border-slate-800 p-1 rounded flex flex-col items-center justify-center min-h-[40px]" 
                                     [class.border-red-500]="item.status === 'ERR'"
                                     [class.border-yellow-500]="item.status === 'WARN'">
                                    <div class="text-[8px] text-slate-500 font-mono">{{item.id}}</div>
                                    <div class="flex items-center gap-1">
                                        <div class="w-1.5 h-1.5 rounded-full"
                                             [class.bg-green-500]="item.status === 'OK'"
                                             [class.bg-yellow-500]="item.status === 'WARN'"
                                             [class.bg-red-500]="item.status === 'ERR'">
                                        </div>
                                        <div class="text-[9px] font-bold text-white">{{item.val}}%</div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (activeTab() === 'Logs') {
                     <div class="h-full bg-black/50 rounded p-2 font-mono text-[10px] text-green-400/80 overflow-y-auto border border-slate-800">
                         @if (isSimulating()) {
                             <div>> SYSTEM_INIT_SEQUENCE_START</div>
                             @for (e of activeEvents(); track e.id) {
                                <div class="text-yellow-500">> EVENT_DETECTED: ID_{{e.id}} ({{e.type}})</div>
                                @if (e.dismissed) {
                                    <div class="text-slate-500">> EVENT_DISMISSED: CRITERIA_NOT_MET (M<4.5 or Int<4)</div>
                                }
                             }
                             @for (r of eewReports(); track r.id) {
                                <div class="text-blue-400">> REPORT_GEN_{{r.reportNum}}: M{{r.mag.toFixed(1)}} (LinearModel)</div>
                             }
                         }
                     </div>
                }
            </div>
        </div>
    }

    <!-- MAP CONTAINER -->
    <div class="flex-1 relative bg-slate-950">
        <div id="map-container" class="absolute inset-0 z-0 bg-slate-900"></div>

        <!-- Mobile FAB to toggle controls -->
        <button 
           (click)="toggleMobileControls()"
           class="md:hidden absolute bottom-6 left-6 z-[400] bg-slate-800 text-white p-4 rounded-full shadow-2xl border border-slate-700 active:scale-95 transition-transform"
           [class.translate-y-24]="showMobileControls()"
        >
           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
        
        <!-- ALERT STACK CONTAINER -->
        <div class="absolute top-4 left-4 right-4 z-[450] flex flex-col gap-2 pointer-events-none md:w-96 md:left-auto md:right-4 md:top-4 max-h-[90vh] overflow-y-auto no-scrollbar">

            <!-- TSUNAMI WARNING BANNER (Original) -->
            @if (tsunamiAlert()) {
                <div class="animate-in slide-in-from-top-5 duration-500 pointer-events-auto">
                    <div class="bg-red-600 text-white p-3 shadow-[0_0_30px_rgba(220,38,38,0.6)] flex items-center justify-between gap-4 border-y-4 border-yellow-400 rounded-lg">
                        <div class="flex items-center gap-3">
                             <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-bounce shrink-0"><path d="m2 6 20 12"/><path d="M7 16V6l10 12V8"/></svg>
                            <div>
                                <h2 class="text-xl font-black uppercase tracking-widest leading-none">Êµ∑ÂòØË≠¶Â†±</h2>
                                <p class="text-[10px] font-bold bg-white text-red-600 px-1 mt-1 inline-block">Á´ãÂç≥ÈÅøÈõ£ EVACUATE</p>
                            </div>
                        </div>
                        <button (click)="dismissTsunami()" class="text-white/80 hover:text-white p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
            }
            
            <!-- VOLCANO WARNING BANNER -->
            @if (volcanoAlert()) {
                <div class="animate-in slide-in-from-top-5 duration-500 pointer-events-auto">
                    <div class="bg-orange-600 text-white p-3 shadow-[0_0_30px_rgba(249,115,22,0.6)] flex items-center justify-between gap-4 border-y-4 border-black rounded-lg">
                        <div class="flex items-center gap-3">
                             <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-pulse shrink-0"><path d="m8 2 4 4 4-4"/><path d="M12 6v8"/><path d="m16 10-4 4-4-4"/><path d="M4 14.8C2.8 15.5 2 16.5 2 18a4 4 0 0 0 4 4h12a4 4 0 0 0 4-4c0-1.5-.8-2.5-2-3.2"/></svg>
                            <div>
                                <h2 class="text-xl font-black uppercase tracking-widest leading-none">ÁÅ´Â±±Âô¥ÁôºË≠¶Â†±</h2>
                                <p class="text-[10px] font-bold bg-black text-orange-500 px-1 mt-1 inline-block">ERUPTION DETECTED</p>
                            </div>
                        </div>
                        <!-- Auto dismisses or manual close -->
                    </div>
                </div>
            }

            <!-- EEW ALERT OVERLAY (Original) -->
            @if (systemStatus() === 'ÁôºÂ∏ÉË≠¶Â†± (ALERTING)') {
                <div class="shadow-2xl animate-in slide-in-from-top-5 duration-300 pointer-events-auto">
                    <div class="bg-slate-900 border-2 border-red-600 rounded-lg overflow-hidden">
                        <!-- Header -->
                        <div class="bg-red-600 px-4 py-2 flex items-center justify-between animate-pulse">
                            <span class="font-black text-white uppercase text-sm flex items-center gap-2">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                                Âú∞ÈúáÈÄüÂ†± (ALERT)
                            </span>
                            <span class="text-[10px] bg-white text-red-700 px-1.5 py-0.5 rounded font-mono font-bold">
                                #{{lastReportNum()}}
                            </span>
                        </div>
                        
                        <!-- Stats -->
                        <div class="p-3 bg-slate-800/95 backdrop-blur border-b border-slate-700 grid grid-cols-2 gap-4">
                             <div>
                                 <span class="text-[9px] text-slate-400 uppercase">È†ê‰º∞Ë¶èÊ®° (Est Mag)</span>
                                 <div class="text-3xl font-black text-white">
                                    {{predictedMagnitude()}}
                                 </div>
                                 <div class="text-[9px] text-yellow-400 mt-1 font-bold animate-pulse">
                                    È†êË®àÊäµÈÅî: {{mainCountdowns().length > 0 ? mainCountdowns()[0].seconds.toFixed(0) + 's' : 'Ë®àÁÆó‰∏≠...'}}
                                 </div>
                             </div>
                             <div class="text-right">
                                 <span class="text-[9px] text-slate-400 uppercase">ÊúÄÂ§ßÈúáÂ∫¶ (Max Int)</span>
                                 <div class="text-3xl font-mono text-purple-400 font-bold">
                                     {{maxDetectedIntensity()}}
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <!-- PHONE SIMULATION (Toggleable, No Zoom) -->
        <div class="fixed bottom-4 right-4 z-[9999] flex flex-col items-end gap-2 pointer-events-none" [class.hidden]="!isSimulating()">
            
            <!-- Phone Container -->
            <div class="transition-all duration-500 origin-bottom-right transform will-change-transform"
                [class.translate-y-[120%]]="!isPhoneOpen()"
                [class.opacity-0]="!isPhoneOpen()"
                [class.translate-y-0]="isPhoneOpen()"
                [class.opacity-100]="isPhoneOpen()">
                <!-- Scale adjustments to fit screen -->
                <div class="pointer-events-auto transform scale-[0.6] sm:scale-75 md:scale-90 lg:scale-100 origin-bottom-right transition-transform duration-300">
                    <app-phone-alert 
                        [active]="isAlertActive()"
                        [time]="currentTimeStr()"
                        [location]="epicenterLocationName()"
                        [magnitude]="predictedMagnitude()"
                        [intensity]="maxDetectedIntensity()"
                        [tsunami]="tsunamiAlert()"
                        [volcano]="volcanoAlert()"
                    ></app-phone-alert>
                </div>
            </div>

            <!-- Toggle Button (Always visible if simulating) -->
            <button (click)="togglePhone()" 
                    class="pointer-events-auto bg-slate-800 hover:bg-slate-700 text-white p-3 rounded-full shadow-lg border border-slate-600 transition-all active:scale-95 flex items-center justify-center gap-2 group">
                @if (isPhoneOpen()) {
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 text-xs font-bold whitespace-nowrap pl-0 group-hover:pl-2">Hide Phone</span>
                } @else {
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
                        @if (systemStatus() === 'ÁôºÂ∏ÉË≠¶Â†± (ALERTING)') {
                            <span class="absolute -top-1 -right-1 flex h-3 w-3">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                            </span>
                        }
                    </div>
                    <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 text-xs font-bold whitespace-nowrap pl-0 group-hover:pl-2">Show Phone</span>
                }
            </button>
        </div>

        <!-- END REPORT DIALOG -->
        @if (systemStatus() === 'ÁµêÊùü (ENDED)') {
             <div class="absolute inset-0 z-[600] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl max-w-sm w-full p-6 animate-in zoom-in duration-300">
                    <div class="text-center mb-6">
                        <div class="text-green-500 font-bold text-xl mb-1">Ê®°Êì¨ÁµêÊùü (Sequence End)</div>
                        <div class="text-slate-400 text-sm">
                            ÂÖ±ÂÅµÊ∏¨Âà∞ {{activeEvents().length}} Ëµ∑Âú∞Èúá‰∫ã‰ª∂
                        </div>
                    </div>
                    
                    <!-- Gemini Analysis Section -->
                    <div class="bg-slate-800/50 rounded p-4 mb-6 min-h-[100px] border border-slate-700 max-h-64 overflow-y-auto">
                        <div class="flex items-center gap-2 mb-2 text-xs font-bold text-blue-400 uppercase">
                             <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                             Gemini AI ÁÅΩÊÉÖÂàÜÊûê
                        </div>
                        @if (aiAnalysis()) {
                            <div class="text-[11px] leading-relaxed text-slate-300 whitespace-pre-wrap">{{aiAnalysis()}}</div>
                        } @else {
                             <div class="flex flex-col items-center justify-center h-20 gap-2">
                                <span class="animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent"></span>
                                <span class="text-xs text-slate-500">Ê≠£Âú®ÂàÜÊûêË§áÂêàÂºèÁÅΩÂÆ≥Êï∏Êìö...</span>
                             </div>
                        }
                    </div>

                    <button (click)="resetSimulation()" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded font-bold transition-colors">
                        ÈáçÁΩÆÁ≥ªÁµ± (RESET)
                    </button>
                </div>
             </div>
        }

    </div>
  </div>
</div>